<!-- Navbar Template -->
<ng-template #navbarTemplate>
    <nav class="bg-primary-800 text-white shadow-md fixed top-0 left-0 right-0 z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <!-- Logo and Mobile Menu Button -->
            <div class="flex items-center space-x-4">
                <!-- Mobile menu button (hidden on lg screens) -->
                <button class="lg:hidden text-white focus:outline-none" (click)="toggleMobileSidebar()">
                    <img src="assets/icons/menu.svg" alt="Menu" class="w-6 h-6" />
                </button>
                <a routerLink="/home" class="text-2xl font-bold">ShopEase</a>
            </div>

            <!-- Desktop Navigation -->
            <div class="hidden lg:flex space-x-6">
                @for (item of navItems(); track item.path) {
                <a [routerLink]="item.path" routerLinkActive="text-primary-200"
                    class="hover:text-primary-200 transition-colors">
                    {{ item.name }}
                </a>
                }
            </div>

            <!-- User Actions -->
            <div class="flex items-center space-x-4">
                <!-- Cart Icon -->
                <button class="relative">
                    <img src="assets/icons/cart.svg" alt="Cart" class="w-6 h-6" />
                    <span
                        class="absolute -top-2 -right-2 bg-danger-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                </button>

                <!-- User Menu -->
                <div class="flex items-center space-x-3">
                    <span class="hidden md:block text-sm">{{ authService.user()?.name }}</span>
                    <button (click)="logout()"
                        class="flex items-center space-x-1 hover:text-primary-200 transition-colors">
                        <img src="assets/icons/logout.svg" alt="Logout" class="w-5 h-5" />
                        <span class="hidden md:block text-sm">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
</ng-template>

<!-- Sidebar Template -->
<ng-template #sidebarTemplate>
    <!-- Desktop Sidebar (permanent on lg screens) -->
    <aside class="hidden lg:flex lg:flex-shrink-0">
        <div class="w-64 h-screen bg-primary-50 border-r border-primary-200 fixed top-0 pt-16 z-20">
            <div class="p-4">
                <div class="flex flex-col space-y-2">
                    @for (item of navItems(); track item.path) {
                    <a [routerLink]="item.path" routerLinkActive="bg-primary-100 text-primary-800"
                        class="px-4 py-3 rounded-lg flex items-center space-x-3 text-primary-700 hover:bg-primary-100 transition-colors">
                        <img [src]="'assets/icons/' + item.icon + '.svg'" [alt]="item.name" class="w-5 h-5" />
                        <span>{{ item.name }}</span>
                    </a>
                    }
                </div>
            </div>
        </div>
    </aside>

    <!-- Mobile Sidebar (off-canvas) -->
    <div class="lg:hidden fixed inset-0 z-40" *ngIf="isMobileSidebarOpen()">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-50" (click)="toggleMobileSidebar()"></div>

        <!-- Sidebar Content -->
        <div class="relative h-full w-64 bg-primary-50 shadow-lg transform transition-transform duration-300 ease-in-out"
            [class.translate-x-0]="isMobileSidebarOpen()" [class.-translate-x-full]="!isMobileSidebarOpen()">

            <div class="p-4 pt-16">
                <button class="absolute top-4 right-4 text-primary-600" (click)="toggleMobileSidebar()">
                    <img src="assets/icons/close.svg" alt="Close" class="w-6 h-6" />
                </button>

                <div class="flex flex-col space-y-2">
                    @for (item of navItems(); track item.path) {
                    <a [routerLink]="item.path" routerLinkActive="bg-primary-100 text-primary-800"
                        class="px-4 py-3 rounded-lg flex items-center space-x-3 text-primary-700 hover:bg-primary-100 transition-colors"
                        (click)="toggleMobileSidebar()">
                        <img [src]="'assets/icons/' + item.icon + '.svg'" [alt]="item.name" class="w-5 h-5" />
                        <span>{{ item.name }}</span>
                    </a>
                    }
                </div>
            </div>
        </div>
    </div>
</ng-template>

<!-- Toaster Template -->
<ng-template #toasterTemplate>
    <div class="fixed bottom-4 right-4 z-50 space-y-3 w-80">
        @for (toast of toaster.toasts(); track toast.id) {
        <div class="p-4 rounded-lg shadow-lg text-white animate-fade-in transform transition-all duration-300"
            [class.bg-success-500]="toast.type === 'success'" [class.bg-danger-500]="toast.type === 'error'"
            [class.bg-warning-500]="toast.type === 'warning'" [class.bg-info-500]="toast.type === 'info'">
            <div class="flex justify-between items-start">
                <div class="flex items-center">
                    <!-- Success Icon -->
                    @if (toast.type === 'success') {
                    <img src="assets/icons/success.svg" alt="Success" class="w-5 h-5 mr-2" />
                    }
                    <!-- Error Icon -->
                    @if (toast.type === 'error') {
                    <img src="assets/icons/error.svg" alt="Error" class="w-5 h-5 mr-2" />
                    }
                    <!-- Warning Icon -->
                    @if (toast.type === 'warning') {
                    <img src="assets/icons/warning.svg" alt="Warning" class="w-5 h-5 mr-2" />
                    }
                    <!-- Info Icon -->
                    @if (toast.type === 'info') {
                    <img src="assets/icons/info.svg" alt="Info" class="w-5 h-5 mr-2" />
                    }
                    <p class="flex-1">{{ toast.message }}</p>
                </div>
                <button class="ml-2 text-white hover:text-white/80 transition-colors"
                    (click)="toaster.dismiss(toast.id)">
                    <img src="assets/icons/close.svg" alt="Close" class="w-4 h-4" />
                </button>
            </div>
        </div>
        }
    </div>
</ng-template>

<!-- Confirmation Template -->
<ng-template #confirmationTemplate>
    @if (confirmation.isOpen()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 transform transition-all duration-300 scale-100">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <img src="assets/icons/warning.svg" alt="Warning" class="w-6 h-6 text-warning-500" />
                </div>
                <h3 class="ml-3 text-xl font-bold text-primary-800">
                    {{ confirmation.config()?.title }}
                </h3>
            </div>

            <p class="text-secondary-600 mb-6">
                {{ confirmation.config()?.message }}
            </p>

            <div class="flex justify-end space-x-3">
                <button
                    class="px-4 py-2 rounded-lg border border-secondary-300 text-secondary-700 hover:bg-secondary-50 transition-colors"
                    (click)="confirmation.handleResponse(false)">
                    {{ confirmation.config()?.cancelText || 'Cancel' }}
                </button>

                <button class="px-4 py-2 rounded-lg bg-danger-500 text-white hover:bg-danger-600 transition-colors"
                    (click)="confirmation.handleResponse(true)">
                    {{ confirmation.config()?.confirmText || 'Confirm' }}
                </button>
            </div>
        </div>
    </div>
    }
</ng-template>

<!-- Main Layout Structure (only shown when authenticated) -->
@if (authService.isAuthenticated()) {
<div class="min-h-screen bg-primary-50">
    <!-- Render Navbar -->
    <ng-container [ngTemplateOutlet]="navbarTemplate"></ng-container>

    <!-- Render Sidebar -->
    <ng-container [ngTemplateOutlet]="sidebarTemplate"></ng-container>

    <!-- Main Content -->
    <main class="lg:ml-64 pt-16 min-h-screen">
        <div class="container mx-auto px-4 py-6">
            <router-outlet></router-outlet>
        </div>
    </main>
</div>
}

<!-- Show router outlet without layout for non-authenticated users -->
@if (!authService.isAuthenticated()) {
<router-outlet></router-outlet>
}

<!-- Always render toaster and confirmation -->
<ng-container [ngTemplateOutlet]="toasterTemplate"></ng-container>
<ng-container [ngTemplateOutlet]="confirmationTemplate"></ng-container>